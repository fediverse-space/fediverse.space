test-frontend:
  image: node:lts-alpine
  stage: test
  before_script:
    - cd frontend
  stage: test
  script:
    - yarn install
    - yarn lint
  cache:
    paths:
      - frontend/node_modules/
      - frontend/.yarn
  except:
    - master
  only:
    changes:
      - frontend/*

backend-sobelow:
  stage: test
  image: elixir:1.9
  only:
    changes:
      - backend/*
  before_script:
    - cd backend
  script:
    - mix local.hex --force
    - mix local.rebar --force
    - mix deps.get
    - mix deps.compile
    - mix sobelow --config
  cache:
    paths:
      - backend/deps/
      - backend/_build/

deploy-backend-develop:
  stage: deploy
  environment:
    name: develop
    url: https://phoenix.api-develop.fediverse.space
  image: ilyasemenov/gitlab-ci-git-push
  only:
    refs:
      - develop
    changes:
      - backend/*
  script:
    - git-push ssh://dokku@api-develop.fediverse.space:22/phoenix

deploy-gephi-develop:
  stage: deploy
  image: ilyasemenov/gitlab-ci-git-push
  environment:
    name: develop
  only:
    refs:
      - develop
    changes:
      - gephi/*
  script:
    - git-push ssh://dokku@api-develop.fediverse.space:22/gephi